<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.7">
<title>Swift Provenance Database</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Swift Provenance Database</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>Swift can be configured to gather and store provenance information about script executions. The following tools are available:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
A set of scripts for extracting provenance information from Swift&#8217;s log files. The extracted data is imported into a relational database, currently PostgreSQL, where it can queried.
</p>
</li>
<li>
<p>
A query interface for provenance with a built-in query language called SPQL (Swift Provenance Query Language). SPQL is similar to SQL except for not having <span class="monospaced">FROM</span>-clauses and join expressions on the <span class="monospaced">WHERE</span>-clause, which are automatically computed for the user. A number of functions and stored procedures that abstract common provenance query patterns are available in both SPQL and SQL.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The tools for managing provenance information in Swift have the following features:</p></div>
<div class="ulist"><ul>
<li>
<p>
Gathering of producer-consumer relationships between data sets and processes.
</p>
</li>
<li>
<p>
Gathering of hierarchical relationships between data sets.
</p>
</li>
<li>
<p>
Gathering of script source code used in each execution.
</p>
</li>
<li>
<p>
Allows users to enrich their provenance records with annotations.
</p>
</li>
<li>
<p>
Gathering of runtime information about application executions.
</p>
</li>
<li>
<p>
Provides a usable and useful query interface for provenance information.
</p>
</li>
</ul></div>
<div class="paragraph"><p>A UML diagram of this provenance model is presented in figure <a href="#provdb_schema">[provdb_schema]</a>. We simplify the UML notation to abbreviate the information that each annotated entity set (script run, function call, and variable) has one annotation entity set per data type. We define entities that correspond to the Open Provenance Model (OPM) notions of artifact, process, and artifact usage (either being consumed or produced by a process). Annotations, which can be added post-execution, represent information about provenance entities such as object version tags and scientific parameters.</p></div>
<div class="imageblock" id="provdb_schema">
<div class="content">
<img src="provdb.svg" alt="Swift provenance database schema" width="1150">
</div>
</div>
<div class="paragraph"><p><span class="monospaced">script</span>: contains the script source code used and its hash value.</p></div>
<div class="paragraph"><p><span class="monospaced">script_run</span>: refers to the execution (successful or unsuccessful) of a script, with attributes such as start time, source code filename, and Swift&#8217;s version.</p></div>
<div class="paragraph"><p><span class="monospaced">function_call</span>: records calls to functions within a script execution. These calls take as input data sets, such as values stored in primitive variables or files referenced by mapped variables; perform some computation specified in the respective function declaration; and produce data sets as output. In Swift, function calls can represent invocations of external applications, built-in functions, and operators; each function call is associated with the script run that invoked it.</p></div>
<div class="paragraph"><p><span class="monospaced">app_fun_call</span>: represents an invocation of an application function (<em>app function</em>). In Swift, it is generated by an invocation to an external application. External applications are listed in an application catalog along with the computational resources on which they can be executed.</p></div>
<div class="paragraph"><p><span class="monospaced">application_execution</span>: represents execution attempts of an external application. Each application function call triggers one or more execution attempts, where one (or, in the case of retries or replication, several) particular computational resource(s) will be selected to actually execute the application.</p></div>
<div class="paragraph"><p><span class="monospaced">runtime_info</span>: contains information associated with an application execution, such as resource consumption.</p></div>
<div class="paragraph"><p><span class="monospaced">dataset</span>: represents data sets that were assigned to variables in a Swift script.</p></div>
<div class="paragraph"><p><span class="monospaced">annot</span>: is a key-value pair associated with either a <span class="monospaced">variable</span>, <span class="monospaced">function_call</span>, or <span class="monospaced">script_run</span>. The annotations are free-form and can be used, for instance, to record scientific-domain parameters, object versions, and user identities.</p></div>
<div class="paragraph"><p>The <span class="monospaced">dataset_in</span> and <span class="monospaced">dataset_out</span> relationships between <span class="monospaced">function_call</span> and <span class="monospaced">variable</span> define a lineage graph that can be traversed to determine ancestors or descendants of a particular entity. Process dependency and data dependency graphs are derived with transitive queries over these relationships.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_design_and_implementation_of_swift_provenance_database">Design and Implementation of Swift Provenance Database</h2>
<div class="sectionbody">
<div class="paragraph"><p>The Swift Provenance Database design is influenced by our survey of provenance queries in many-task computing. Built-in functions and stored procedures can be used to follow the transitive closure of basic provenance relationships, such as data containment hierarchies, and data derivation and consumption; or for correlating attributes from multiple script runs, such as annotation values or the values of function call parameters.</p></div>
<div class="sect2">
<h3 id="_provenance_gathering_and_storage">Provenance Gathering and Storage</h3>
<div class="paragraph"><p>Swift can be configured to add both prospective and retrospective provenance information to its log files.  The provenance extraction mechanism processes these log files, filters the entries that contain provenance data, and exports this information to a relational database. Each application execution is started by a wrapper script that sets up the execution environment. We modified these scripts to also gather runtime information, such as memory consumption and processor load.  Additionally, one can define a script that generates annotations in the form of key-value pairs, to be executed immediately before the actual application. These annotations can be exported to the provenance database and associated with the respective application execution. The data logged by each wrapper is processed to extract both the runtime information and the annotations, storing them in the provenance database. Additional annotations can be generated per script run
using <em>ad-hoc</em> annotator scripts. In addition to retrospective provenance, Swift Provenance Database keeps prospective provenance by recording the Swift script source code, the application catalog, and the site catalog used in each script run.</p></div>
</div>
<div class="sect2">
<h3 id="_query_interface">Query Interface</h3>
<div class="paragraph"><p>During the Third Provenance Challenge, we observed that expressing provenance queries in SQL is often cumbersome. For example, such queries require extensive use of complex relational joins which are beyond the level of complexity that most domain scientists are willing, or have the time, to master and write. Swift Provenance Query Language, SPQL for short, was designed to allow for easier design of provenance queries for common query patterns than can be accomplished with general purpose query languages, such as SQL.
In the query interface, every SPQL query is translated into a SQL query that is processed by the underlying relational database. While the syntax of SPQL is by design similar to SQL, it does not require detailed knowledge of the underlying database schema for designing queries, but rather only of the entities in a simpler, higher-level abstract provenance schema, and their respective attributes.</p></div>
<div class="paragraph"><p>The basic building block of a SPQL query consists of a selection query with the following format:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>select (distinct) selectClause
(where            whereClause
(group by         groupByClause
(order by         orderByClause)))</pre>
</div></div>
<div class="paragraph"><p>Where the optional parts are within parentheses. As in the relational data model, every query or built-in function results in a table, to preserve the power of SQL in querying results of another query. Selection queries can be composed using the usual set operations: union, intersection, and difference. A <span class="monospaced">select</span> clause is a list with elements of the form <span class="monospaced">&lt;entity set name&gt;(.&lt;attribute name&gt;)</span> or <span class="monospaced">&lt;built-in function name&gt;(.&lt;return attribute name&gt;)</span>. If attribute names are omitted, the query returns all the existing attributes of the entity set. SPQL supports the same aggregation, grouping, set operation and ordering constructs provided by SQL.</p></div>
<div class="paragraph"><p>To simplify the schema that the user needs to understand to design queries, we used database views to define the  higher-level schema presentation shown in <a href="#provdb_schema_summary">[provdb_schema_summary]</a>. This abstract, OPM-compliant provenance schema, is a simplified view of the physical database schema detailed in section. It groups information related to a provenance entity set in a single relation. The annotation entity set shown is the union of the annotation entity sets of the underlying database, presented in Figure. To avoid defining one annotation table per data type, we use dynamic expression evaluation in the SPQL to SQL translator to determine the required type-specific annotation table of the underlying provenance database.</p></div>
<div class="imageblock" id="provdb_schema_summary">
<div class="content">
<img src="provdb-uml-summary.svg" alt="Summary of Swift provenance database schema" width="800">
</div>
</div>
<div class="paragraph"><p>To simplify query design, we included  in SPQL the following built-in functions to make these common provenance queries easier to express:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">ancestors(object_id})</span> returns a table with a single column containing the identifiers of variables and function calls that precede a particular node in a provenance graph stored in the database.
</p>
</li>
<li>
<p>
<span class="monospaced">data_dependencies(variable_id})</span>, related to the previous built-in function, returns the identifiers of variables upon which <span class="monospaced">variable_id</span> depends.
</p>
</li>
<li>
<p>
<span class="monospaced">function_call_dependencies(function_call_id})</span> returns the identifiers of function calls upon which <span class="monospaced">function_call_id</span> depends.
</p>
</li>
<li>
<p>
<span class="monospaced">compare_run(list of &lt;function_parameter=string | annotation_key=string)</span> shows how process parameters or annotation values vary across the script runs stored in the database.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The underlying SQL implementation of the <span class="monospaced">ancestor</span> built-in function, below, uses recursive Common Query Expressions, which are supported in the SQL:1999 standard. It uses the <span class="monospaced">prov\_graph</span> database view, which is derived from the <span class="monospaced">dataset\_in</span> and <span class="monospaced">dataset_out</span> tables, resulting in a table containing the edges of the provenance graph.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>CREATE FUNCTION ancestors(varchar)  RETURNS SETOF varchar AS $$
WITH RECURSIVE anc(ancestor,descendant) AS
  (
       SELECT parent AS ancestor, child AS descendant
       FROM   prov_graph
       WHERE child=$1
     UNION
       SELECT prov_graph.parent AS ancestor,
              anc.descendant AS descendant
       FROM   anc, prov_graph
       WHERE  anc.ancestor=prov_graph.child
  )
  SELECT ancestor FROM anc $$ ;</pre>
</div></div>
<div class="paragraph"><p>To further simplify query specification, SPQL uses a generic mechanism for computing the {em from} clauses and the join expressions of the <span class="monospaced">where</span> clause for the target SQL query. The SPQL to SQL query translator first scans all the entities present in the SPQL query. A shortest path containing all these entities is computed in the graph defined by the schema of the provenance database. All the entities present in this shortest path are listed in the <span class="monospaced">from</span> clause of the target SQL query. The join expressions of the <span class="monospaced">where</span> clause of the target query are computed using the edges of the shortest path, where each edge derives an expression that equates the attributes involved in the foreign key constraint of the entities that define the edge. While this automated join computation facilitates query design, it does somewhat reduce the expressivity of SPQL, as one is not able to perform other types of joins, such as self-joins, explicitly. However, many such queries can be expressed using subqueries,
which are supported by SPQL. While some of the expressive power of SQL is thus lost, we show in the sections that follow that SPQL is able to express, with far less effort and complexity, most important and useful queries that provenance query patterns require. For example, this SPQL query returns the value of the parameter <span class="monospaced">proteinId</span> per script run that consumed a file named <span class="monospaced">nr</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>select  compare_run(parameter='proteinId').run_id  where  file.name='nr';</pre>
</div></div>
<div class="paragraph"><p>This SPQL query is translated by Swift Provenance Database to the following SQL query:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>select compare_run1.run_id
from   select run_id, j1.value AS proteinId
       from compare_run_by_param('proteinId') as compare_run1,
       run, proc, ds_use, ds, file
where  compare_run1.run_id=run.id and ds_use.proc_id=proc.id and
       ds_use.ds_id=ds.id and ds.id=file.id and
       run.id=proc.run_id and file.name='nr';</pre>
</div></div>
<div class="paragraph"><p>Further queries are illustrated by example in the next section. We note here that the SPQL query interface also lets the user submit standard SQL statements to query the database.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tutorial">Tutorial</h2>
<div class="sectionbody">
<div class="paragraph"><p>Swift Provenance Database is a set of scripts, SQL functions and stored procedures, and a query interface. It extracts provenance information from Swift&#8217;s log files into a relational database. The tools are downloadable through SVN with the command:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>svn co https://svn.ci.uchicago.edu/svn/vdl2/provenancedb</pre>
</div></div>
<div class="sect2">
<h3 id="_database_configuration">Database Configuration</h3>
<div class="paragraph"><p>Swift Provenance Database depends on PostgreSQL, version 9.0 or later, due to the use of <em>Common Table Expressions</em> for computing transitive closures of data derivation relationships, supported only on these versions. The file <span class="monospaced">prov-init.sql</span> contains the database schema, and the file <span class="monospaced">pql_functions.sql</span> contain the function and stored procedure definitions. If the user has not created a provenance database yet, this can be done with the following commands (one may need to add "<span class="monospaced">-U</span> <em>username</em>" and "<span class="monospaced">-h</span> <em>hostname</em>" before the database name "<span class="monospaced">provdb</span>", depending on the database server configuration):</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>createdb provdb
psql -f prov-init.sql provdb
psql -f pql-functions.sql provdb</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_swift_provenance_database_configuration">Swift Provenance Database Configuration</h3>
<div class="paragraph"><p>The file <span class="monospaced">etc/provenance.config</span> should be edited to define the database configuration. The location of the directory containing the log files should be defined in the variable <span class="monospaced">LOGREPO</span>. For instance:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>export LOGREPO=~/swift-logs/</pre>
</div></div>
<div class="paragraph"><p>The command used for connecting to the database should be defined in the variable SQLCMD. For example, to connect to CI&#8217;s PostgreSQL? database:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>export SQLCMD="psql -h db.ci.uchicago.edu -U provdb provdb"</pre>
</div></div>
<div class="paragraph"><p>The script <span class="monospaced">./swift-prov-import-all-logs</span> will import provenance information from the log files in <span class="monospaced">$LOGREPO</span> into the database. The command line option <span class="monospaced">-rebuild</span> will initialize the database before importing provenance information.</p></div>
</div>
<div class="sect2">
<h3 id="_swift_configuration">Swift Configuration</h3>
<div class="paragraph"><p>To enable the generation of provenance information in Swift&#8217;s log files and to trasfer wrapper logs back to the submitting machine for runtime behavior information extraction the options <span class="monospaced">provenance.log</span> and wrapperlog.always.transfer=true should be set to true in <span class="monospaced">etc/swift.properties</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>provenance.log=true
wrapperlog.always.transfer=true</pre>
</div></div>
<div class="paragraph"><p>If Swift&#8217;s SVN revision is 3417 or greater, the following options should be set in <span class="monospaced">etc/log4j.properties</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>log4j.logger.swift=DEBUG
log4j.logger.org.griphyn.vdl.karajan.lib=DEBUG</pre>
</div></div>
<div class="sect3">
<h4 id="_enriching_provenance_data_with_runtime_resource_consumption_statistics">Enriching Provenance Data with Runtime Resource Consumption Statistics</h4>
<div class="paragraph"><p>A modified version of <span class="monospaced">_swiftwrap</span> can be used to gather additional information on runtime resource comsumption, such as processor, memory, I/O, and swap use. One should backup the original <span class="monospaced">_swiftwrap</span> script and replace it with the modified one:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>cp $SWIFT_HOME/libexec/_swiftwrap $SWIFT_HOME/libexec/_swiftwrap-backup
cp swift_mod/_swiftwrap_runtime_snapshots $SWIFT_HOME/libexec/_swiftwrap</pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_example_modis">Example: MODIS</h3>
<div class="paragraph"><p>Run MODIS:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>swift modis.swift</pre>
</div></div>
<div class="paragraph"><p>After running MODIS, one can import provenenace information into the database using:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>swift-prov-import-all-logs</pre>
</div></div>
<div class="paragraph"><p>Connect to the provenance database:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>psql provdb</pre>
</div></div>
<div class="paragraph"><p>List runs that were imported to the database:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>SELECT script_filename, swift_version, cog_version, final_state, start_time, duration
FROM   script_run;

 script_filename | swift_version | cog_version | final_state |         start_time         | duration
-----------------+---------------+-------------+-------------+----------------------------+----------
 modis.swift     | 5483          | 3339        | SUCCESS     | 2012-10-26 11:46:51.282-02 |  100.724
 modis.swift     | 5483          | 3339        | SUCCESS     | 2012-10-26 11:44:59.909-02 |   85.050</pre>
</div></div>
<div class="paragraph"><p>List the datasets and function calls from which the dataset dataset:20121026-1146-jng6bir4:720000001604 was derived:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>select * from ancestors('dataset:20121026-1146-jng6bir4:720000001604');

                         ancestors
---------------------------------------------------------+-
 modis-20121026-1146-yp9rbbx5:0
 modis-20121026-1146-yp9rbbx5:0-6
 dataset:20121026-1146-jng6bir4:720000000335
 dataset:20121026-1146-jng6bir4:720000000653
 dataset:20121026-1146-jng6bir4:720000000007
 modis-20121026-1146-yp9rbbx5:jng6bir4:720000000335
 dataset:20121026-1146-jng6bir4:720000000336
 ...
 dataset:20121026-1146-jng6bir4:720000000107
 dataset:20121026-1146-jng6bir4:720000000015
 dataset:20121026-1146-jng6bir4:720000000006</pre>
</div></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Last updated 2013-06-08 07:07:18 BRT
</div>
</div>
</body>
</html>
